# 更新日志

## 1.0.8 (2025-02-15)

### 修复
- 修复socket.getaddrinfo同步阻塞问题，改为异步DNS解析
- 修复SSRF TOCTOU/DNS Rebinding风险，添加逐跳URL验证
- 修复重定向链路安全问题，手动逐跳处理并校验
- 修复临时文件后缀问题，根据Content-Type推断正确后缀
- 修复AudioSegment.converter并发干扰，使用锁保护
- 修复API响应结构缺少健壮性校验问题

### 改进
- 添加惰性初始化机制，确保HTTP session可用
- 添加自定义异常类型（DownloadError, UnsafeURLError等）
- 改进URL校验函数，返回具体失败原因
- 改进音频格式判断，允许application/octet-stream
- 添加音频解码验证，失败时给出友好提示
- 将关键行为参数纳入插件配置（分段时长、发送间隔、最大文件大小）
- 改进异常处理，保留因果链（raise ... from e）
- 添加更详细的错误日志（包含URL、状态码等关键信息）

## 1.0.7 (2025-02-15)

### 修复
- 修复下载歌曲时Connection closed错误
- 修复重定向处理逻辑，使用aiohttp自动跟随重定向
- 修复连接管理问题，防止连接泄漏

### 改进
- 添加下载重试机制（最多3次）
- 添加ClientPayloadError异常处理
- 优化错误日志，提供更详细的调试信息
- 改进临时文件清理逻辑

## 1.0.6 (2025-02-15)

### 修复
- 修复_export_segment伪异步问题，改为同步函数
- 修复点歌指令触发冲突，避免重复匹配
- 修复重定向处理逻辑，使用async with防止响应对象泄漏
- 修复AudioSegment.converter全局修改问题，恢复原始值

### 改进
- 增强SSRF防护，添加DNS rebinding防护和IPv6私网地址检测
- 严格化Content-Type校验，使用白名单并添加文件扩展名验证
- 集中封装配置读取函数，减少重复代码
- 聚合会话状态到统一数据结构，简化管理
- 增强initialize()幂等性，防止重复初始化
- 处理CancelledError，确保临时文件清理

## 1.0.5 (2025-02-15)

### 修复
- 优化日志输出，降低过程噪音日志级别到debug
- 移除play_song_by_number中的冗余re.match
- 修复关键字提取方式，使用更精确的前缀移除
- 修复self._http_session可能为None的竞态问题
- 切换音源时更新会话时间戳
- 修复下载超限时的临时文件泄漏
- 改进下载失败的错误反馈
- 修复SSRF风险，允许重定向但校验重定向链
- 修复私网网段判断不准确问题
- 修复临时文件名拼接的路径注入风险
- 改进Content-Type校验，不允许空值

### 改进
- 添加会话状态后台清理机制
- 添加并发限制，防止DoS攻击
- 增加请求超时时间到120秒
- 拆分_split_and_send_audio函数，提高代码可维护性

## 1.0.4 (2025-02-15)

### 修复
- 修复由于上个版本修复了一堆bug导致播放失败的问题（现在我脸黑到想给人炸了）

## 1.0.3 (2025-02-15)

### 修复
- 修了若干个bug（挺多就不列举了）
- 添加详细的日志输出，方便调试和问题排查

### 改进
- 代码质量优化
- 添加详细的函数注释和文档字符串
- 改进错误处理，提供更友好的用户提示

## 1.0.2 (2025-02-15)

### 变更
- 简化播放指令，仅保留 `点歌x` 格式
- 移除 `点歌第一个`、`点歌第x个`、`点歌第x首` 指令（指令太多，不想修）

### 指令
- `点歌x` - 播放第x首歌曲（x为数字，如：点歌1、点歌2），在此前提需要先点歌（例如：点歌 起风了）才有效

## 1.0.1 (2025-02-14)

### 新增功能
- 后台配置搜索结果数量

### 配置
- **搜索结果显示数量**：搜索结果显示的歌曲数量（5-30）

### 依赖
- aiohttp >= 3.8.0
- pydub >= 0.25.1
- FFmpeg（自动检测）

### 修复
- 优化 FFmpeg 自动检测（跨平台支持）
- 修复播放地址获取逻辑
- 增强错误处理和日志记录
